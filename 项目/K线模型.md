# K线模型策略开发
## 背景(要解决什么问题)
> 如何从K线图里面找到信号？(模型层面)
> 如何利用Spark做大数据回测？(数据计算层面)

## 如何从K线图里找到信号
> 根据一些人的研究，连续K线的形状可能能反映当前行情的变化，比如连续三根下降的阴线，连续三根上涨的
> 不妨将一系列连续的K线定义为K线模型，人是能识别了，机器不能识别，所以首先要解决的问题：
那么首先得做的就是如何提取特征，定义K线模型，使得机器能够识别
> 然后需要解决的是如何在历史行情数据中验证该模型的效果？
(即历史行情中出现了该模型时，其后续发展如何，统计各项指标)

### 如何定义K线模型
> 定义K线，需要既能表现单根K线的形状，又能表现K线与K线之间相对位置关系
> k线模型就是连续的K线
> 在借鉴和思考之后，采用了以下的指标来定义每根K线，即其特征向量
1. 颜色
2. 实体长度
3. 上影线
4. 下影线
5. 与上一根K线的相对位置
k1 = {color, bl, w1, w2, rp}
K-Model = {k1, k2, k3, ...}
### 如何在历史行情数据中验证该模型(回测)
> 其实要解决的问题：如何找到历史数据中符合该特征的K线模型，即与自定义的K线模型匹配
> 想法是：
1. 将存储在Hbase中的历史数据(股票+时间为key，OHLC为value)取出，然后转化成我们对K线的定义
2. 然后衡量K线模型之间的相似度，相似度高的就认为匹配

> 如何衡量模型之间的相似度(模糊匹配)
1. 衡量每根K线之间的相似度(模糊匹配的方式计算每一个特征指标)
2. 根据K线列表的最小相似度作为K线
3. 设置一个匹配阈值，一旦相似度超过阈值，则认为当前K线模型与自定义的模型相匹配，即为历史的信号点

> 如何计算K线之间的相似度(模糊匹配)
1. 每个K线都存在特征向量，根据特征向量的距离即可判断K线的相似性
2. 怎么计算特征向量的距离

> 出现问题：
不同股票的涨跌幅幅度差异较大
1. 采用权重的方式，乘以一个波动性权重
> 这种方式能解决，在思考这个问题时，又想到了另一种向量距离的度量方式()
2. 采用余弦定理的方式，将N根K线进行铺平，整成一个大向量

> 余弦度量出现问题: 如果衡量每根K线，然后上升至K线模型，会导致K线之间的一致性不好
采取的方法为：将N根K线铺平生成一个大向量，作为value值，然后衡量两者的相似性



## 如何利用Spark做大数据量的回测
> Spark程序的两个关键点:
1. 如何分区
2. 每个分区内的运算逻辑(task的计算逻辑)

### 如何分区
> 由于在定义K线模型时，每只股票之间必须是逻辑隔离的，所以一只股票处于一个分区的做法较好，一来可以减少分区内的逻辑复杂性，二来可以增大并发度(会将不同的股票放在不同的分区内计算，不同的分区对应不同的task)
> 默认的分区函数采用Hash，所以以股票ID作为Key值进行分区其实并不好，可以采用一个Map配置文件，将股票ID进行编号，这样对应的分区必然不同

### 如何计算
> 从数据从Hbase中取出
> Mapper 将value转化为定义的指标向量(color1, bl1, ....)
> Repartition 然后重新分区，增大分区数以提高并发度，将value和每个(涉及shuffle过程)
> Filter 将匹配度高于阈值的数据取出，写入Hbase
